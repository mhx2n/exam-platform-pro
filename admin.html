<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Admin Dashboard</title>
<link rel="stylesheet" href="style.css">
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAGg5aZ9dSlfMqIReuumDk3QlkJtC-880I",
  authDomain: "csv-exam-system-9e643.firebaseapp.com",
  projectId: "csv-exam-system-9e643",
  storageBucket: "csv-exam-system-9e643.firebasestorage.app",
  messagingSenderId: "243008760655",
  appId: "1:243008760655:web:42f168ee0b75da6234333a"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let questions = [];

window.adminLogin = async function(){
  const email = document.getElementById("email").value;
  const pass = document.getElementById("password").value;

  try{
    await signInWithEmailAndPassword(auth, email, pass);
    document.getElementById("loginCard").style.display="none";
    document.getElementById("dashboard").style.display="block";
    loadExams();
  }catch(e){
    alert("Login Failed: " + e.message);
  }
}

document.addEventListener("change", function(e){
  if(e.target.id === "csvFile"){
    Papa.parse(e.target.files[0],{
      header:true,
      skipEmptyLines:true,
      complete:function(results){
        questions = results.data;
        alert("CSV Loaded");
      }
    });
  }
});

window.createExam = async function(){

  const mode = document.getElementById("mode").value;

  const exam = {
    title: title.value,
    subject: subject.value,
    university: university.value,
    department: department.value,
    timer: parseInt(timer.value),
    negative: parseFloat(negative.value),
    shuffle: shuffle.checked,
    mode: mode,
    liveCode: mode==="live" ? Math.floor(100000+Math.random()*900000).toString() : null,
    questions: questions,
    createdAt: new Date()
  };

  await addDoc(collection(db,"exams"), exam);
  alert("Exam Published!");
  loadExams();
}

async function loadExams(){
  const snapshot = await getDocs(collection(db,"exams"));
  let html="";
  snapshot.forEach(docSnap=>{
    const data = docSnap.data();
    html += `
      <div class="card">
        <b>${data.title}</b><br>
        ${data.subject} | ${data.mode}<br>
        ${data.mode==="live" ? "Live Code: "+data.liveCode : ""}
        <br><button onclick="deleteExam('${docSnap.id}')">Delete</button>
      </div>
    `;
  });
  document.getElementById("examList").innerHTML = html;
}

window.deleteExam = async function(id){
  await deleteDoc(doc(db,"exams",id));
  loadExams();
}

</script>
</head>
<body>

<div class="container">

<h2>üîê Admin Login</h2>

<div class="card" id="loginCard">
  <input type="email" id="email" placeholder="Admin Email"><br>
  <input type="password" id="password" placeholder="Password"><br>
  <button onclick="adminLogin()">Login</button>
</div>

<div id="dashboard" style="display:none;">

<h2>üìä Admin Dashboard</h2>

<div class="card">
  <h3>Create Exam</h3>

  <input type="text" id="title" placeholder="Exam Title"><br>

  <input type="text" id="subject" placeholder="Subject"><br>
  <input type="text" id="university" placeholder="University"><br>
  <input type="text" id="department" placeholder="Department"><br>

  <input type="number" id="timer" placeholder="Timer (minutes)"><br>
  <input type="number" id="negative" placeholder="Negative Mark" step="0.1"><br>

  <label>
    <input type="checkbox" id="shuffle"> Shuffle Questions
  </label><br>

  <select id="mode">
    <option value="practice">Practice Mode</option>
    <option value="live">Live Mode</option>
  </select><br><br>

  <input type="file" id="csvFile"><br><br>

  <button onclick="createExam()">Create & Publish</button>
</div>

<div class="card">
  <h3>All Exams</h3>
  <div id="examList"></div>
</div>

</div>

</div>

</body>
</html>
